# Torrentio Integration - Visual Architecture

## User's Journey: Episode Completion & Auto-Play

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         USER PLAYS TV SHOW EPISODE                        â”‚
â”‚                      (Friends S03E02 via Stremio)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    Player receives stream URL from Stremio
                           (via Torrentio addon)
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   PlayIT Player starts     â”‚
                    â”‚   Media3 ExoPlayer streams â”‚
                    â”‚   from Torbox cached file  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   User watches episode...          â”‚
                    â”‚   Player saves position every 30s  â”‚
                    â”‚   (22:44 minutes total length)     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                              [TIME PASSES]
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Playback reaches end of stream      â”‚
                    â”‚   Player fires STATE_ENDED event      â”‚
                    â”‚   Position: 22:44 (at duration)       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   PlayerActivity detects STATE_ENDED   â”‚
                    â”‚   Confirms truly at end (within 1s)    â”‚
                    â”‚   hasCompletionHandled = true          â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   handlePlaybackCompletion()           â”‚
                    â”‚   Is TV show? YES (has S03E02 data)    â”‚
                    â”‚   Has Stremio callback? NO (fallback)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   attemptPlayNextEpisode()                      â”‚
                    â”‚   attemptTMDBAutoNextEpisode(S03E02)            â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      TMDB & TORRENTIO INTEGRATION                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  1. Extract Show Name from Filename     â”‚
                    â”‚     "Friends.S03E02.1080p.mkv" â†’        â”‚
                    â”‚     showName = "Friends"                â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  2. TMDB Search: Show Name â†’ TMDB Show ID  â”‚
                    â”‚                                             â”‚
                    â”‚  GET /search/tv?query=Friends              â”‚
                    â”‚  Response: { "results": [{                 â”‚
                    â”‚    "id": 1668,                             â”‚
                    â”‚    "name": "Friends",                      â”‚
                    â”‚    "first_air_date": "1994-09-22"         â”‚
                    â”‚  }]}                                       â”‚
                    â”‚                                             â”‚
                    â”‚  âœ“ Found TMDB ID: 1668                     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  3. TMDB Details: Show ID â†’ IMDB ID        â”‚
                    â”‚                                             â”‚
                    â”‚  GET /tv/1668?api_key=...                  â”‚
                    â”‚  Response: {                                â”‚
                    â”‚    "id": 1668,                             â”‚
                    â”‚    "name": "Friends",                      â”‚
                    â”‚    "external_ids": {                       â”‚
                    â”‚      "imdb_id": "tt0108778"                â”‚
                    â”‚    }                                       â”‚
                    â”‚  }                                          â”‚
                    â”‚                                             â”‚
                    â”‚  âœ“ Found IMDB ID: tt0108778                â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  4. Torrentio Query: IMDB ID + S03E03 â†’ Streams   â”‚
                    â”‚                                                    â”‚
                    â”‚  GET /stream/series/tt0108778/3/3.json            â”‚
                    â”‚  (Note: Asking for NEXT episode S03E03)           â”‚
                    â”‚                                                    â”‚
                    â”‚  Response: {                                       â”‚
                    â”‚    "streams": [                                    â”‚
                    â”‚      {                                             â”‚
                    â”‚        "title": "ðŸ“º Torbox | 1080p | 2.1GB",      â”‚
                    â”‚        "url": "https://myfiles.torbox.com/..."    â”‚
                    â”‚      },                                            â”‚
                    â”‚      {                                             â”‚
                    â”‚        "title": "ðŸ”¥ RealDebrid | 720p | 1.5GB",   â”‚
                    â”‚        "url": "https://myfiles.rd-server.com/..." â”‚
                    â”‚      },                                            â”‚
                    â”‚      {                                             â”‚
                    â”‚        "title": "âš¡ Alldebrid | 480p | 900MB",     â”‚
                    â”‚        "url": "https://myfiles.alldebrid.com/..." â”‚
                    â”‚      }                                             â”‚
                    â”‚    ]                                              â”‚
                    â”‚  }                                                 â”‚
                    â”‚                                                    â”‚
                    â”‚  âœ“ Found 3 streams                                â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  5. Select Best Stream                           â”‚
                    â”‚                                                   â”‚
                    â”‚  Selection Criteria (in order):                  â”‚
                    â”‚  â‘  Torbox (preferred) > RealDebrid > Alldebrid  â”‚
                    â”‚  â‘¡ 1080p > 720p > 480p                          â”‚
                    â”‚  â‘¢ Smaller file size = faster start             â”‚
                    â”‚                                                   â”‚
                    â”‚  Ranking:                                         â”‚
                    â”‚  1st: Torbox + 1080p = â­ BEST                   â”‚
                    â”‚  2nd: RealDebrid + 1080p                        â”‚
                    â”‚  3rd: Torbox + 720p                             â”‚
                    â”‚  4th: Alldebrid + 480p                          â”‚
                    â”‚                                                   â”‚
                    â”‚  âœ“ Selected:                                     â”‚
                    â”‚    "ðŸ“º Torbox | 1080p | 2.1GB"                  â”‚
                    â”‚    URL: https://myfiles.torbox.com/Friends/...  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        AUTO-PLAY NEXT EPISODE                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  6. Create Intent for Next Episode          â”‚
                    â”‚                                              â”‚
                    â”‚  Intent {                                    â”‚
                    â”‚    action: ACTION_VIEW                       â”‚
                    â”‚    data: https://myfiles.torbox.com/...      â”‚
                    â”‚    extras: {                                 â”‚
                    â”‚      season: 3                               â”‚
                    â”‚      episode: 3                              â”‚
                    â”‚      startfrom: 0                            â”‚
                    â”‚      return_result: true                     â”‚
                    â”‚    }                                         â”‚
                    â”‚  }                                           â”‚
                    â”‚                                              â”‚
                    â”‚  âœ“ Intent prepared                           â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  7. Auto-Play Next Episode                  â”‚
                    â”‚                                              â”‚
                    â”‚  setResult(RESULT_OK, nextIntent)           â”‚
                    â”‚  resultIntentAlreadySet = true              â”‚
                    â”‚  finish()                                    â”‚
                    â”‚                                              â”‚
                    â”‚  âœ“ Intent returned to Stremio              â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         STREMIO AUTO-PLAY LAUNCH                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Stremio receives result Intent             â”‚
                    â”‚  Extracts stream URL from data              â”‚
                    â”‚  Launches PlayIT again with new URL         â”‚
                    â”‚  (Friends S03E03, startfrom: 0)            â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  PlayerActivity onCreate                    â”‚
                    â”‚  Detects: S03E03 (not S03E02)              â”‚
                    â”‚  mediaUrl = new stream from Torbox          â”‚
                    â”‚  resumePositionMs = 0                       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  PlayerScreen creates Media3 player         â”‚
                    â”‚  Prepares next episode stream               â”‚
                    â”‚  Player starts from position 0              â”‚
                    â”‚  Episode 3 begins playing!                  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  âœ… AUTO-PLAY SUCCESS                      â”‚
                    â”‚  User seamlessly continues to next episode  â”‚
                    â”‚  No manual selection needed                 â”‚
                    â”‚  No return to Stremio UI needed            â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## API Call Sequence Diagram

```
PlayIT App                 TMDB API                  Torrentio API
     â”‚                        â”‚                            â”‚
     â”‚â”€â”€â”€â”€ Search Show â”€â”€â”€â”€â”€â”€â”€>â”‚                            â”‚
     â”‚      "Friends"          â”‚                            â”‚
     â”‚                        â”‚                            â”‚
     â”‚<â”€â”€â”€â”€ TMDB Show ID â”€â”€â”€â”€â”€â”€â”‚                            â”‚
     â”‚      (id: 1668)         â”‚                            â”‚
     â”‚                        â”‚                            â”‚
     â”‚â”€â”€â”€â”€ Get IMDB ID â”€â”€â”€â”€â”€â”€â”€>â”‚                            â”‚
     â”‚      (showId: 1668)     â”‚                            â”‚
     â”‚                        â”‚                            â”‚
     â”‚<â”€â”€â”€â”€ IMDB ID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                            â”‚
     â”‚      (tt0108778)        â”‚                            â”‚
     â”‚                                                      â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Query Streams â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                   (imdbId: tt0108778,               â”‚
     â”‚                    season: 3, episode: 3)          â”‚
     â”‚                                                      â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Streams JSON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                 (array of 5-10 streams)            â”‚
     â”‚                                                      â”‚
     â”‚ [Select Best Stream]                                â”‚
     â”‚ (Torbox 1080p preferred)                            â”‚
     â”‚                                                      â”‚
     â”‚ [Create Auto-Play Intent]                           â”‚
     â”‚ [Return to Stremio]                                 â”‚
     â”‚                                                      â”‚
     â””â”€â”€â”€â”€â”€â”€â”€ Next Episode URL â”€â”€â”€â”€â”€â”€> Stremio
                                           â”‚
                                      [Launches PlayIT again]
```

---

## Data Flow: Resume Position Handling

```
Episode Playback
    â”‚
    â”œâ”€ Every 30 seconds
    â”‚  â””â”€ Save position to database
    â”‚     (ResumeRepository.savePosition)
    â”‚
    â”œâ”€ At error
    â”‚  â””â”€ Capture CURRENT position
    â”‚     â””â”€ Use for retry, NOT initial resume position
    â”‚
    â””â”€ At STATE_ENDED
       â”‚
       â””â”€ Get FINAL position from player
          â””â”€ This is sent back to Stremio
             as completion signal

Stremio receives result
    â”‚
    â”œâ”€ position == duration?
    â”‚  â””â”€ YES: Episode marked as completed
    â”‚
    â””â”€ position < duration?
       â””â”€ NO: Resume position saved for next time
```

---

## Error Recovery Flow

```
Network Error During Playback
    â”‚
    â”œâ”€ Capture current playback position
    â”‚  â””â”€ retryPosition = currentPos (not initial resumePosition)
    â”‚
    â”œâ”€ Is network error?
    â”‚  â””â”€ YES: retryCount++
    â”‚
    â”œâ”€ retryCount < MAX_RETRIES (3)?
    â”‚  â”‚
    â”‚  â”œâ”€ YES
    â”‚  â”‚  â”œâ”€ Wait 2 seconds
    â”‚  â”‚  â”œâ”€ Retry playback from retryPosition
    â”‚  â”‚  â”‚  â””â”€ User resumes exactly where interrupted
    â”‚  â”‚  â””â”€ If successful, continue playback
    â”‚  â”‚
    â”‚  â””â”€ NO
    â”‚     â””â”€ Too many retries
    â”‚        â””â”€ Display error to user
    â”‚
    â””â”€ Return or finish gracefully

At finish():
    â””â”€ Send position back to Stremio
       â””â”€ Stremio saves resume position
```

---

## Fallback Chain

If any step fails, app has fallbacks:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Episode Completes                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Has Stremio     â”‚
    â”‚ Callback URL?   â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚      â”‚
        YES    NO
         â”‚      â”‚
         â”‚    â”Œâ”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚    â”‚ Try TMDB auto-play     â”‚
         â”‚    â”‚ â”œâ”€ Extract show name   â”‚
         â”‚    â”‚ â”œâ”€ TMDB lookup         â”‚
         â”‚    â”‚ â”œâ”€ Torrentio query     â”‚
         â”‚    â”‚ â””â”€ Auto-play           â”‚
         â”‚    â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
         â”‚       â”‚                 â”‚
         â”‚    SUCCESS           FAIL
         â”‚       â”‚                 â”‚
         â”‚       â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚       â”‚    â”‚ Return to Stremio   â”‚
         â”‚       â”‚    â”‚ UI for manual next  â”‚
         â”‚       â”‚    â”‚ episode selection   â”‚
         â”‚       â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚       â”‚
         â””â”€â”€â”€â”¬â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Auto-play next      â”‚
    â”‚ episode seamlessly  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Key Advantages Visualized

```
Traditional Flow (No Torrentio)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

User watches episode
    â†“
Episode ends
    â†“
[Manual selection needed]
    â†“
User goes back to Stremio
    â†“
Searches for next episode
    â†“
Selects stream manually
    â†“
Episode plays
    â†“
â±ï¸  Takes: 30-60 seconds of manual work


New Flow (With Torrentio Integration)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

User watches episode
    â†“
Episode ends
    â†“
[Automatic lookup]
    â†“
TMDB finds show
    â†“
Torrentio finds streams
    â†“
Best stream selected
    â†“
Next episode plays automatically
    â†“
â±ï¸  Takes: ~3-5 seconds, no manual work
```

---

## Real-World Example

```
User: "I'm watching Friends Season 3"

PlayIT Flow:
1. Currently playing: Friends.S03E02.1080p.Bluray.mkv
   Position: 0:00 / 22:44

2. User watches episode (22:44 seconds)

3. Episode ends â†’ STATE_ENDED fires
   
4. PlayerActivity detects completion
   â””â”€ "Is TV show?" â†’ YES (has S03 E02)
   â””â”€ "Has callback URL?" â†’ NO (fallback mode)

5. TMDB Pipeline:
   â””â”€ Show: "Friends" (extracted from filename)
   â””â”€ TMDB: Found show (id: 1668)
   â””â”€ TMDB: Found IMDB ID (tt0108778)

6. Torrentio Query:
   â””â”€ GET /stream/series/tt0108778/3/3.json
   â””â”€ Returns 7 available streams

7. Stream Selection:
   â””â”€ Torbox 1080p (2.1GB) âœ“ SELECTED
   â””â”€ RealDebrid 1080p (3GB)
   â””â”€ Alldebrid 720p (1.5GB)
   â””â”€ [others]

8. Auto-Play:
   â””â”€ setResult(RESULT_OK, nextEpisodeIntent)
   â””â”€ finish()
   â””â”€ Stremio receives result

9. Stremio launches PlayIT again:
   â””â”€ URL: https://myfiles.torbox.com/Friends/...
   â””â”€ Season: 3, Episode: 3
   â””â”€ StartFrom: 0

10. PlayIT reopens:
    â””â”€ PlayerActivity onCreate
    â””â”€ PlayerScreen launches
    â””â”€ Episode 3 starts from beginning
    â””â”€ User continues watching seamlessly âœ…

â° Total time: ~3-5 seconds (includes network requests)
ðŸ‘¤ User effort: 0 (completely automatic)
ðŸ˜Š User experience: Seamless continuation
```

